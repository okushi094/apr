<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ESP32-Car 音声制御</title>
<style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin: 5px; padding: 10px; font-size: 16px; }
</style>
</head>
<body>
<h1>ESP32-Car 音声制御</h1>
<button id="connect">ESP32-Carに接続</button>
<button id="start-rec">音声認識開始</button>
<p id="status">未接続</p>
<p id="result">音声入力: </p>
 
  <script>
    const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b"; // ESP32側と一致
    const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8"; // ESP32側と一致
 
    let device, server, characteristic;
 
    // --- ESP32-Carに接続 ---
    document.getElementById("connect").onclick = async () => {
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'ESP32-Car' }],   // ← 名前フィルタに変更
          optionalServices: [SERVICE_UUID]
        });
        server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
 
        document.getElementById("status").textContent = "接続しました: " + device.name;
      } catch (error) {
        console.error(error);
        document.getElementById("status").textContent = "接続失敗: " + error;
      }
    };
 
    // --- 音声認識開始 ---
    document.getElementById("start-rec").onclick = () => {
      if (!('webkitSpeechRecognition' in window)) {
        alert("このブラウザは音声認識に対応していません");
        return;
      }
 
      const recognition = new webkitSpeechRecognition();
      recognition.lang = "ja-JP";
      recognition.continuous = false;
      recognition.interimResults = false;
 
      recognition.start();
 
      recognition.onresult = async (event) => {
        const text = event.results[0][0].transcript;
        document.getElementById("result").textContent = "音声入力: " + text;
 
        let commandValue = 0;
        if (text.includes("前")) commandValue = 1;
        else if (text.includes("止")) commandValue = 2;
        else if (text.includes("左")) commandValue = 3;
        else if (text.includes("右")) commandValue = 4;
 
        if (characteristic && commandValue > 0) {
          const data = new Uint8Array([commandValue]);
          await characteristic.writeValue(data);
          document.getElementById("status").textContent = "送信: " + commandValue;
        }
      };
 
      recognition.onerror = (event) => {
        console.error(event);
        document.getElementById("status").textContent = "音声認識エラー";
      };
    };
</script>
</body>
</html>
