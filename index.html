<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32éŸ³å£°åˆ¶å¾¡</title>
    <!-- Tailwind CSSã‚’CDNã‹ã‚‰èª­ã¿è¾¼ã¿ã€ç¾ã—ã„UIã‚’ä½œæˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Interãƒ•ã‚©ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-4 min-h-screen flex flex-col items-center justify-center">

    <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-lg w-full max-w-sm">
        <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« -->
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-900 dark:text-gray-100">éŸ³å£°ã§ESP32ã‚’åˆ¶å¾¡</h1>
        
        <!-- æ¥ç¶šãƒœã‚¿ãƒ³ -->
        <button id="connectButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-full transition-all duration-300 transform active:scale-95 shadow-lg mb-4">
            ESP32ã«æ¥ç¶š
        </button>

        <!-- éŸ³å£°ã‚³ãƒãƒ³ãƒ‰ãƒœã‚¿ãƒ³ -->
        <button id="voiceButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-full transition-all duration-300 transform active:scale-95 shadow-lg" disabled>
            <svg class="inline-block w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm7 5a1 1 0 011-1h2a1 1 0 011 1v2.586a1 1 0 01-.293.707l-3 3A1 1 0 0113 15h-1a1 1 0 01-1-1v-2a1 1 0 011-1h1zm-7 0a1 1 0 011-1h1a1 1 0 011 1v2a1 1 0 01-1 1h-1a1 1 0 01-1-1v-2zM4 11a1 1 0 011-1h1a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1v-2z" clip-rule="evenodd"></path>
                <path d="M11 16a3 3 0 10-2 0v2a1 1 0 102 0v-2z"></path>
            </svg>
            éŸ³å£°ã‚³ãƒãƒ³ãƒ‰ã‚’é–‹å§‹
        </button>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="mt-6 space-y-3 p-4 bg-gray-50 dark:bg-gray-700 rounded-2xl">
            <div class="flex items-center">
                <span class="font-semibold text-gray-600 dark:text-gray-400">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span>
                <span id="status" class="ml-2 text-red-500 font-medium">åˆ‡æ–­æ¸ˆã¿</span>
            </div>
            <div class="flex items-center">
                <span class="font-semibold text-gray-600 dark:text-gray-400">èªè­˜ã—ãŸéŸ³å£°:</span>
                <!-- éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <span id="recognizedText" class="ml-2 text-gray-900 dark:text-gray-100">---</span>
            </div>
            <div class="flex items-center">
                <span class="font-semibold text-gray-600 dark:text-gray-400">é€ä¿¡ã‚³ãƒãƒ³ãƒ‰:</span>
                <span id="sentCommand" class="ml-2 text-gray-900 dark:text-gray-100">---</span>
            </div>
        </div>

        <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="messageBox" class="mt-6 p-4 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-200 rounded-2xl hidden transition-all duration-300">
            <p id="messageText"></p>
        </div>
    </div>

    <script>
        // UUIDã¯ESP32ã®ã‚³ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦å®šç¾©
        // Web Bluetoothã®ä»•æ§˜ã«åˆã‚ã›ã¦å°æ–‡å­—ã«ä¿®æ­£
        const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const CHARACTERISTIC_UUID_RX = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
        const CHARACTERISTIC_UUID_TX = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

        // UIè¦ç´ 
        const connectButton = document.getElementById('connectButton');
        const voiceButton = document.getElementById('voiceButton');
        const statusElement = document.getElementById('status');
        const recognizedTextElement = document.getElementById('recognizedText');
        const sentCommandElement = document.getElementById('sentCommand');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        let device;
        let rxCharacteristic;

        // éŸ³å£°èªè­˜APIã®æº–å‚™
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true; // é€£ç¶šèªè­˜ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            recognition.interimResults = true; // ä¸­é–“çµæœã‚’è¡¨ç¤ºã™ã‚‹
            recognition.lang = 'ja-JP'; // æ—¥æœ¬èªã‚’è¨­å®š
        } else {
            showMessage("ã‚¨ãƒ©ãƒ¼: ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚æœ€æ–°ã®Android Chromeã§è©¦ã—ã¦ãã ã•ã„ã€‚");
            voiceButton.disabled = true;
        }

        // ã‚³ãƒãƒ³ãƒ‰ã¨å€¤ã®å¯¾å¿œ
        const commandMap = {
            "é€²ã‚“ã§": 1,
            "æ­¢ã¾ã£ã¦": 0,
            "å·¦ã¸": 2,
            "å³ã¸": 3,
            "å‰ã¸": 1,
            "ã‚¹ãƒˆãƒƒãƒ—": 0,
            "å·¦": 2,
            "å³": 3,
        };
        
        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã«ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹
         * @param {string} msg - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         */
        function showMessage(msg) {
            messageText.textContent = msg;
            messageBox.classList.remove('hidden');
        }

        /**
         * UIã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã™ã‚‹
         * @param {string} statusMsg - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
         * @param {string} color - è‰² (Tailwindã‚¯ãƒ©ã‚¹)
         */
        function updateStatus(statusMsg, color) {
            statusElement.textContent = statusMsg;
            statusElement.className = `ml-2 font-medium text-${color}-500`;
        }
        
        /**
         * BLEãƒ‡ãƒã‚¤ã‚¹ã«æ¥ç¶šã™ã‚‹
         */
        connectButton.addEventListener('click', async () => {
            updateStatus('æ¥ç¶šä¸­...', 'yellow');
            try {
                // ã‚µãƒ¼ãƒ“ã‚¹UUIDã¨ãƒ‡ãƒã‚¤ã‚¹åã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32-Car' }],
                    optionalServices: [SERVICE_UUID]
                });
                
                // GATTã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š
                const server = await device.gatt.connect();
                // ã‚µãƒ¼ãƒ“ã‚¹ã®å–å¾—
                const service = await server.getPrimaryService(SERVICE_UUID);
                // å—ä¿¡ç”¨ã®ç‰¹æ€§ï¼ˆCharacteristicï¼‰ã‚’å–å¾—
                rxCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID_RX);

                // æ¥ç¶šå®Œäº†
                updateStatus('æ¥ç¶šæ¸ˆã¿', 'green');
                voiceButton.disabled = false;
                connectButton.textContent = 'å†æ¥ç¶š';
                showMessage("æ¥ç¶šãŒå®Œäº†ã—ã¾ã—ãŸï¼ã€ŒéŸ³å£°ã‚³ãƒãƒ³ãƒ‰ã‚’é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚");
                
                // åˆ‡æ–­æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
                device.addEventListener('gattserverdisconnected', onDisconnected);

            } catch (error) {
                console.error('BLEæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                updateStatus('æ¥ç¶šå¤±æ•—', 'red');
                showMessage(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
                voiceButton.disabled = true;
            }
        });

        /**
         * BLEãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰åˆ‡æ–­ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
         */
        function onDisconnected() {
            console.log('BLEãƒ‡ãƒã‚¤ã‚¹ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
            updateStatus('åˆ‡æ–­æ¸ˆã¿', 'red');
            voiceButton.disabled = true;
            showMessage('ESP32ã¨ã®æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦ã€ŒESP32ã«æ¥ç¶šã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
        }

        /**
         * éŸ³å£°ã‚³ãƒãƒ³ãƒ‰ã‚’é–‹å§‹ã™ã‚‹
         */
        voiceButton.addEventListener('click', () => {
            if (!rxCharacteristic) {
                showMessage("ESP32ã«æ¥ç¶šã—ã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšæ¥ç¶šã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            recognizedTextElement.textContent = "è´å–ä¸­...";
            sentCommandElement.textContent = "---";
            messageBox.classList.add('hidden');
            if (recognition) {
                // ğŸ’¡ä¿®æ­£: navigator.mediaDevices.getUserMedia()ã®å‘¼ã³å‡ºã—ã‚’å‰Šé™¤ã—ã€
                // SpeechRecognition.start()ã«ãƒã‚¤ã‚¯ã®è¨±å¯å‡¦ç†ã‚’ä»»ã›ã‚‹
                try {
                    recognition.start();
                } catch (e) {
                    console.error('éŸ³å£°èªè­˜é–‹å§‹ã‚¨ãƒ©ãƒ¼:', e);
                    showMessage(`éŸ³å£°èªè­˜é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${e.message}`);
                }
            } else {
                 showMessage("ã‚¨ãƒ©ãƒ¼: éŸ³å£°èªè­˜ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
            }
        });

        /**
         * éŸ³å£°èªè­˜ã®çµæœã‚’å‡¦ç†ã™ã‚‹
         */
        recognit
